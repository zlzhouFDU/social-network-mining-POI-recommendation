<!DOCTYPE html>
<meta charset="utf-8">
<title>NYC Map Visualization</title>
<html>
    <head>
        <!-- 引入字体style文件 -->
        <link rel="stylesheet" type="text/css"
            href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400italic,600italic,700italic,200,300,400,600,700,900">
        <!-- 引入d3.js v7版本；-->
        <script src="d3.v7.min.js"></script>
        <!-- 引入leaflet.js和leaflet.css -->
        <link rel="stylesheet" href="leaflet.css" />
        <script src="leaflet.js"></script>
        <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
        crossorigin=""></script> -->
        <style>
            /* 设置各级标题style */
            body, h1, h2, h3, p {
            margin: 0;
            padding: 0;
            font-family: 'Georgia', fangsong;
            font-size: 1em;
            color: #333;
            font-weight: 400;
            }

            h1 {
            line-height: 1em;
            font-size: 1.75em;
            font-weight: 900;
            color: #000;
        }

            h2 {
                line-height: 1em;
                font-size: 1.45em;
                font-weight: 900;
                color: #111111d1;
            }

            #map {
                height: 550px;
                width: 1000px;
                margin: 10px 10px 10px 10px;
			    padding: 0px;
            }

            #slider-container {
            margin: 10px 10px 10px 10px;
        }

            #slider {
                width: 300px; /* 滑动条的宽度 */
                margin: 10px 0; /* 上下的边距 */
            }

            #legend {
            margin: 10px 10px 10px 10px;
            }

            .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.7);
            color: #000;
            font-size: 10px;
            /* 添加阴影效果 */
            -moz-box-shadow:    3px 3px 10px 0px rgba(0, 0, 0, 0.25);
            -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
            box-shadow:         3px 3px 10px 0px rgba(0, 0, 0, 0.25);
}
            
        </style>
    </head>

    <body>
        <h1>Trajectory of representative individuals</h1>
        <div id="map"></div>
        <script>
            // 创建地图实例
            let map = L.map('map').setView([40.7128, -74.0060], 11); // 纽约市的经纬度
            // 添加地图层
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            let isPaused = false;

            // 添加暂停的控制按钮
            let pauseButton = L.control({ position: 'topright' });
            pauseButton.onAdd = function (map) {
                let div = L.DomUtil.create('div', 'pause-button');
                div.innerHTML = '<button onclick="togglePause()">Pause</button>';
                return div;
            };
            pauseButton.addTo(map);

            // 切换暂停状态的函数
            window.togglePause = function () {
                isPaused = !isPaused;
                document.querySelector('.pause-button button').innerHTML = isPaused ? 'Continue' : 'Pause';
            };

            // 初始化轨迹和访问次数
            let user1Path = L.polyline([], { color: 'blue', weight: 3, opacity: 0.7 }).addTo(map);
            let user2Path = L.polyline([], { color: 'red', weight: 3, opacity: 0.7 }).addTo(map);
            let user1VisitCounts = {};
            let user2VisitCounts = {};


            function createUserMarker(lat, lng, category, timestamp, userColor, user) {
                    let key = lat + ',' + lng; // 创建唯一的键来标识每个地点
                    if (user === 'user1') {
                        user1VisitCounts[key] = (user1VisitCounts[key] || 0) + 1;
                    } else if (user === 'user2') {
                        user2VisitCounts[key] = (user2VisitCounts[key] || 0) + 1;
                    } else if (user === 'user3') {
                        user3VisitCounts[key] = (user3VisitCounts[key] || 0) + 1;
                    }

                let user1Count = user1VisitCounts[key] || 0;
                let user2Count = user2VisitCounts[key] || 0;
                let sumCount = getSumVisitCount(lat, lng);
                let radius = Math.max(5 + 0.5 * sumCount, 6);
                let color = getMixedColor(user1VisitCounts[key] || 0, user2VisitCounts[key] || 0);
                let popupContent = `<b>${category}</b><br>${timestamp}<br>User1 Visits: ${user1Count}<br>User2 Visits: ${user2Count}`;

                let marker = L.circleMarker([lat, lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 0.5
                }).addTo(map);
                marker.bindPopup(popupContent, {
                    className: 'custom-popup'
                }).openPopup();
                return marker;
            }

            // 无动画，直接绘制
            function createUserMarker_direct(lat, lng, category, timestamp, userColor, user) {
                    let key = lat + ',' + lng;
                    if (user === 'user1') {
                        user1VisitCounts[key] = (user1VisitCounts[key] || 0) + 1;
                    } else if (user === 'user2') {
                        user2VisitCounts[key] = (user2VisitCounts[key] || 0) + 1;
                    } else if (user === 'user3') {
                        user3VisitCounts[key] = (user3VisitCounts[key] || 0) + 1;
                    }

                    let user1Count = user1VisitCounts[key] || 0;
                    let user2Count = user2VisitCounts[key] || 0;
                    let user3Count = user3VisitCounts[key] || 0;
                    let sumCount = getSumVisitCount(lat, lng);
                    let radius = Math.max(5 + 0.5 * sumCount, 6);
                    let color = getMixedColor(user1VisitCounts[key] || 0, user2VisitCounts[key] || 0);
                    let popupContent = `<b>${category}</b><br>${timestamp}<br>User1 Visits: ${user1Count}<br>User2 Visits: ${user2Count}`;

                    let marker = L.circleMarker([lat, lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 0.5
                    }).addTo(map);
                    marker.bindPopup(popupContent, {
                        className: 'custom-popup'
                    });
                    return marker;
                }

            // 解析时间戳
            function parseTimestamp(timestamp) {
                    let match = timestamp.match(/(\w{3}) (\w{3}) (\d{2}) (\d{2}:\d{2}:\d{2}) \+0000 (\d{4})/);
                    if (match) {
                        let [_, dayOfWeek, month, day, time, year] = match;
                        let monthNumber = new Date(Date.parse(month + " 1, 2021")).getMonth() + 1;
                        let standardTimestamp = `${year}-${monthNumber.toString().padStart(2, '0')}-${day} ${time}`;
                        return standardTimestamp;
                    } else {
                        return null;
                    }
                }

            // 根据userId筛选数据
            function usergroup(userId, data) {
                return data.filter(d => d.userId === userId).map(d => {
                    d.utcTimestamp = parseTimestamp(d.utcTimestamp);
                    return d;
                });
            }

            // 合并数据并按时间排序
            function mergeAndSortData(users) {
                    let combinedData = [].concat(...users.map((user, index) => user.map(item => ({ ...item, user: `user${index + 1}` }))));
                    combinedData.sort((a, b) => new Date(a.utcTimestamp) - new Date(b.utcTimestamp));
                    return combinedData;
                }


            // 绘制轨迹（一个用户）
            function drawTrajectory_one(user, path, userColor) {
                user.forEach(function (data, index) {
                    setTimeout(function () {
                        if (isPaused) {
                            return;
                        }
                        let lat = data.latitude;
                        let lng = data.longitude;
                        let category = data.venueCategory;
                        let timestamp = data.utcTimestamp;

                        if (index > 0) {
                            path.addLatLng([lat, lng]);
                        }

                        let marker = createUserMarker(lat, lng, category, timestamp, userColor, 'user1');

                        if (index === 0 || user[index - 1].venueId !== data.venueId) {
                            marker.openPopup();
                            setTimeout(function () {
                                marker.closePopup();
                            }, 2000);
                        }
                    }, 1000 * index);
                });
            }


            // 获得两个用户总访问次数
            function getSumVisitCount(lat, lng) {
                    let key = lat + ',' + lng;
                    let user1Count = user1VisitCounts[key] || 0;
                    let user2Count = user2VisitCounts[key] || 0;
                    if (user1Count === 0 || user2Count === 0) {
                        return 0;
                    }
                    return user1Count+user2Count;
                }

            // 获得两个用户访问次数的混合颜色
            function getMixedColor(user1Count, user2Count) {
                let total = user1Count + user2Count;
                let red = (255 * user2Count) / total;
                let blue = (255 * user1Count) / total;
                return `rgb(${red.toFixed(0)}, 0, ${blue.toFixed(0)})`;
            }

            // 绘制轨迹（两个用户）
            function drawTrajectory_two(combinedData) {
                    combinedData.forEach(function (data, index) {
                        setTimeout(function () {
                            if (isPaused) {
                                return;
                            }

                            let userColor = data.user === 'user1' ? 'blue' : 'red';

                            createUserMarker(data.latitude, data.longitude, data.venueCategory, data.utcTimestamp, userColor, data.user);

                        }, 1000 * index);
                    });
                }
            
            // 无动画，直接绘制
            function drawTrajectory_direct(combinedData) {
                    combinedData.forEach(function (data) {
                        let userColor = data.user === 'user1' ? 'blue' : 'red';
                        createUserMarker_direct(data.latitude, data.longitude, data.venueCategory, data.utcTimestamp, userColor, data.user);
                    });
                }
            
            
            // 读取数据
            Promise.all([d3.csv('mod_2014_NYC.csv')]).then(function (files) {
                let rc = files[0];
                let user1 = usergroup('680', rc); // 展示用户ID为 680, 888的轨迹
                let user2 = usergroup('888', rc);

                let combinedData = mergeAndSortData([user1, user2]);

                //drawTrajectory_one(user1, user1Path, 'blue');
                drawTrajectory_two(combinedData);
                });
        </script>
    </body>

</html>