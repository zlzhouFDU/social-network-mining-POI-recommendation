<!DOCTYPE html>
<meta charset="utf-8">
<title>NYC Visualization</title>
<html>
    <head>
        <!-- 引入字体style文件 -->
        <link rel="stylesheet" type="text/css"
            href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400italic,600italic,700italic,200,300,400,600,700,900">
        <!-- 引入d3.js v7版本；-->
        <script src="d3.v7.min.js"></script>
        <!-- 引入leaflet.js和leaflet.css -->
        <link rel="stylesheet" href="leaflet.css" />
        <script src="leaflet.js"></script>
        <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
        crossorigin=""></script> -->
        <style>
            /* 设置各级标题style */
            body, h1, h2, h3, p {
            margin: 3;
            padding: 0;
            font-family: 'Georgia', fangsong;
            font-size: 1em;
            color: #333;
            font-weight: 400;
            }

            h1 {
            line-height: 1em;
            font-size: 1.75em;
            font-weight: 900;
            color: #000;
        }

            h2 {
                line-height: 1em;
                font-size: 1.45em;
                font-weight: 900;
                color: #111111d1;
            }

            #map {
                height: 450px;
                width: 1000px;
                margin: 10px 10px 10px 10px;
			    padding: 0px;
            }

            #slider-container {
            margin: 5px 10px 10px 10px;
        }

            #slider {
                width: 300px; /* 滑动条的宽度 */
                margin: 10px 0; /* 上下的边距 */
            }

            #legend { /* 图例的样式 */
            margin: 10px 10px 10px 10px;
            }

            .btn {
            background-color: #4CAF50; /* 绿色背景 */
            color: white; /* 白色文字 */
            padding: 10px 15px; /* 内部填充 */
            border: none; /* 无边框 */
            border-radius: 5px; /* 圆角边框 */
            cursor: pointer; /* 鼠标悬浮时的手形图标 */
            margin: 12px; /* 外部边距 */
            transition: background-color 0.3s; /* 过渡效果 */
        }

            .btn:hover {
                background-color: #45a049; /* 按钮悬浮时的背景颜色 */
            }
            
        </style>
    </head>

    <body>
        <h1>POI Heat Map</h1>
        <div id="button-container">
            <!-- 添加按钮 -->
            <button id="btn-all" class="btn">Show All Data</button>
            <button id="btn-community1" class="btn">Community ID 3</button>
            <button id="btn-community2" class="btn">Community ID 20</button>
        </div>
        <div id="slider-container">
            Filter Threshold: <span id="threshold">50</span>
            <input type="range" id="slider" min="0" max="100" value="50" step="1">
        </div>
        <div id="legend"></div>
        <div id="map"></div>
        <script>
            // 创建地图实例
            let map = L.map('map').setView([40.7128, -74.0060], 12); // 纽约市的经纬度

            // 添加地图层
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            


            filePromises = []; // 用于存储所有的文件promise
            filePromises.push(d3.csv('overallcount_2014_NYC.csv'));
            filePromises.push(d3.csv('mod_2014_NYC.csv'));
            filePromises.push(d3.csv('comm3.csv'));
            filePromises.push(d3.csv('comm20.csv'));


            Promise.all(filePromises).then(function (files) {
                let overall = files[0];
                let rc = files[1];
                let comm3 = files[2];
                let comm20 = files[3];
                
                // 颜色比例尺
                let colorScale = d3.scaleThreshold()
                    .domain([50, 100, 150, 200, 250, 300, 350, 400])
                    .range(d3.schemeReds[9]);
                

                document.getElementById('slider').oninput = function () {
                    updateMap(Number(this.value));
                };

                let currentData = overall; // 初始化当前数据集为 overall
                function updateMap(data, threshold) {
                    document.getElementById('threshold').innerText = threshold;
                    
                    // 移除所有旧的圆形标记
                    map.eachLayer(function (layer) {
                        if (layer instanceof L.CircleMarker) {
                            map.removeLayer(layer);
                        }
                    });

                    let filtered = data.filter(function (d) {
                        return d.count > threshold;
                    });

                    // 计算当前显示数据的最大 count 值
                    let maxCount = d3.max(filtered, function (d) { return Number(d.count); });
                    let bin = Math.floor((maxCount - threshold)/75);
                    colorScale.domain(d3.range(threshold, maxCount, bin));

                    drawMap(filtered);
                    updateLegend(colorScale);
                }

                function drawMap(csvData) {
                    csvData.forEach(function (d) {
                        let marker = L.circleMarker([d.latitude, d.longitude], {
                            radius: 5,
                            fillColor: colorScale(d.count),
                            color: "#000",
                            weight: 1,
                            opacity: 0.9,
                            fillOpacity: 0.8
                        }).addTo(map);
                        marker.bindPopup(d.venueCategory + '<br>Visits: ' + d.count);
                    });
                }

                // 绘制图例
                function updateLegend(colorScale) {
                    // 清除旧的图例
                    d3.select("#legend").selectAll("*").remove();

                    // 获取颜色比例尺的域和范围
                    let colorDomain = colorScale.domain();
                    let colorRange = colorScale.range();

                    // 创建 SVG 容器
                    let svg = d3.select("#legend").append("svg")
                        .attr("width", 300)
                        .attr("height", 50);

                    // 绘制图例条
                    colorDomain.forEach(function (d, i) {
                        svg.append("rect")
                            .attr("x", i * 30)
                            .attr("width", 30)
                            .attr("height", 15)
                            .style("fill", colorRange[i]);

                        svg.append("text")
                            .attr("x", i * 30)
                            .attr("y", 40)
                            .text(d)
                            .style("font-size", "12px");
                    });
                }


                document.getElementById('btn-all').onclick = function () {
                    currentData = overall;
                    updateMap(currentData, Number(document.getElementById('slider').value));
                };

                document.getElementById('btn-community1').onclick = function () {
                    currentData = comm3;
                    updateMap(currentData, Number(document.getElementById('slider').value));
                };

                document.getElementById('btn-community2').onclick = function () {
                    currentData = comm20;
                    updateMap(currentData, Number(document.getElementById('slider').value));
                };
                updateMap(currentData, 50);
                document.getElementById('slider').oninput = function () {
                    updateMap(currentData, Number(this.value));
                };
            });
        </script>
    </body>

</html>